<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>LCDãƒ›ãƒ¯ã‚¤ãƒˆã‚¹ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’</title>
<link rel="stylesheet" href="common-layout.css">
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
}

body {
  font-family: sans-serif;
  background-color: white !important; /* ì´ˆê¸° ë°°ê²½ìƒ‰ì€ ë‹¤ì‹œ í°ìƒ‰ìœ¼ë¡œ */
  cursor: default;
  transition: background-color 0.5s ease-in-out;
}

/* ì „ì²´í™”ë©´ í™œì„± ëª¨ë“œì¼ ë•Œ HTMLê³¼ BODYì— ëŒ€í•œ ìŠ¤íƒ€ì¼ */
html.fullscreen-active-mode {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden;
  z-index: 9999;
}

/* ì¶”ê°€: ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•Œ bodyì˜ ë°°ê²½ìƒ‰ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šë„ë¡ */
html.fullscreen-active-mode body {
   background-color: initial !important; /* ë˜ëŠ” white !important; */
}


html.fullscreen-active-mode h1,
html.fullscreen-active-mode .nav-buttons,
html.fullscreen-active-mode .start-button,
html.fullscreen-active-mode p.instruction-text,
html.fullscreen-active-mode #touch-instruction { /* í„°ì¹˜ ì§€ì‹œ ë©”ì‹œì§€ë„ ìˆ¨ê¹€ */
  display: none !important;
}

.start-button {
  display: block;
  margin: 50px auto 30px auto;
  width: 250px;
  height: auto;
  cursor: pointer;
  z-index: 5;
}

p.instruction-text { /* ê¸°ì¡´ ì„¤ëª… í…ìŠ¤íŠ¸ */
  font-size: 18px;
  margin: -30px auto 30px auto;
  text-align: center;
  max-width: 80%;
}

/* í„°ì¹˜ ìœ ë„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ - HTMLì— ì¸ë¼ì¸ìœ¼ë¡œë„ ìˆì§€ë§Œ, ì—¬ê¸°ì„œë„ ê´€ë¦¬ ê°€ëŠ¥ */
#touch-instruction {
  font-size: 24px;
  color: #333; /* ì˜ ë³´ì´ë„ë¡ ìƒ‰ìƒ ì§€ì • */
  position: absolute; /* í™”ë©´ ì¤‘ì•™ ë°°ì¹˜ë¥¼ ìœ„í•´ */
  top: 25%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
  text-align: center;
  padding: 20px; /* í„°ì¹˜ ì˜ì—­ í™•ë³´ ë° ê°€ë…ì„± */
  /* background-color: rgba(255, 255, 255, 0.8); /* í•„ìš”í•˜ë‹¤ë©´ ë°°ê²½ ì¶”ê°€ */
  /* border-radius: 10px; */
}

.hidden {
  display: none;
}

audio {
  display: none;
}
</style>
</head>
<body>

<h1><a href="../index.html" class="title-link">LCDãƒ›ãƒ¯ã‚¤ãƒˆã‚¹ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆ</a></h1>

<img id="start" class="start-button" src="../media/images/whitespot-button.png" alt="ã‚¹ã‚¿ãƒ¼ãƒˆ">
<p class="instruction-text">ç”»é¢ã«ã‚·ãƒŸã‚„ç™½ã„ç‚¹ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ğŸ˜º</p>

<p id="touch-instruction" class="hidden">ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è‰²ãŒå¤‰ã‚ã‚‹ã‚ˆğŸ¤©</p>

<div id="nav" class="nav-buttons">
  <button onclick="playAndNavigate('sound-previous', 'speaker-test.html')">â¬… å‰ã®ãƒ†ã‚¹ãƒˆ</button>
  <button onclick="playAndNavigate('sound-home', '../index.html')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
  <button onclick="playAndNavigate('sound-next', 'youtube-test.html')">æ¬¡ã®ãƒ†ã‚¹ãƒˆ â¡</button>
</div>

<audio id="sound-previous" src="../media/audio/previous-button-sound.mp3"></audio>
<audio id="sound-home" src="../media/audio/home-button-sound.mp3"></audio>
<audio id="sound-next" src="../media/audio/next-button-sound.mp3"></audio>

<script>
const colors = ['white','red', 'green', 'blue', 'black','white'];
let currentIndex = -1;
let testStarted = false; // í…ŒìŠ¤íŠ¸ê°€ ì‹¤ì œë¡œ ìƒ‰ìƒ ë³€ê²½ì„ ì‹œì‘í–ˆëŠ”ì§€ ì—¬ë¶€
const htmlEl = document.documentElement;
const startButton = document.getElementById("start");
const h1Title = document.querySelector('h1');
const initialInstructionText = document.querySelector('p.instruction-text'); // ì›ë˜ ìˆë˜ ì„¤ëª…
const navButtons = document.getElementById("nav");
const touchInstructionMessage = document.getElementById("touch-instruction");

function showInitialUIElements(show) {
    const action = show ? "remove" : "add";
    startButton.classList[action]("hidden");
    h1Title.classList[action]("hidden");
    initialInstructionText.classList[action]("hidden");
    navButtons.classList[action]("hidden");
}

// ìŠ¤íƒ€íŠ¸ ë²„íŠ¼ í´ë¦­/í„°ì¹˜ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜
function prepareForTest() {
    showInitialUIElements(false); // ì‹œì‘ ë²„íŠ¼, ì œëª©, ê¸°ì¡´ ì„¤ëª…, ë‚´ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸°
    touchInstructionMessage.classList.remove("hidden"); // "í™”ë©´ í„°ì¹˜" ì•ˆë‚´ ë©”ì‹œì§€ ë³´ì´ê¸°
    // ì•„ì§ testStarted = false ìƒíƒœ. ì‹¤ì œ í„°ì¹˜ê°€ ìˆì–´ì•¼ í…ŒìŠ¤íŠ¸ ì‹œì‘.
}

// "í™”ë©´ í„°ì¹˜" ë©”ì‹œì§€ í›„ ì‹¤ì œ í„°ì¹˜ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜
function initiateColorChangeAndFullscreen() {
    if (testStarted) return; // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

    testStarted = true; // ì´ì œ ì§„ì§œ í…ŒìŠ¤íŠ¸ ì‹œì‘!
    currentIndex = -1;
    touchInstructionMessage.classList.add("hidden"); // "í™”ë©´ í„°ì¹˜" ì•ˆë‚´ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°

    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš©(í„°ì¹˜) ì§í›„ ì „ì²´í™”ë©´ ì‹œë„
    setTimeout(() => {
        tryFullscreen().then(success => {
            if (!success) {
                activateSimulatedFullscreen();
            }
            document.body.style.cursor = "none"; // ì»¤ì„œ ìˆ¨ê¸°ê¸°
            showNextColor(); // ì²« ë²ˆì§¸ ìƒ‰ìƒ í‘œì‹œ
        });
    }, 10); // ì•„ì£¼ ì§§ì€ ì§€ì—° ì‹œê°„
}

function tryFullscreen() {
    return new Promise(resolve => {
        if (document.body.requestFullscreen) {
            document.body.requestFullscreen()
                .then(() => resolve(true))
                .catch(err => {
                    console.warn("ì „ì²´í™”ë©´ ìš”ì²­ ì‹¤íŒ¨:", err);
                    resolve(false);
                });
        } else {
            resolve(false); // ì „ì²´í™”ë©´ API ë¯¸ì§€ì›
        }
    });
}

function activateSimulatedFullscreen() {
    htmlEl.classList.add('fullscreen-active-mode');
    // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œì—ì„œëŠ” bodyì˜ ë°°ê²½ìƒ‰ì„ htmlì´ ì œì–´í•˜ë„ë¡ í•  ìˆ˜ ìˆìŒ
    // ì•„ë‹ˆë©´ JavaScriptì—ì„œ html, body ë‘˜ ë‹¤ ë°°ê²½ìƒ‰ ì„¤ì •
}

function endTest() {
    testStarted = false;
    currentIndex = -1;

    const exitFullscreenPromise = document.fullscreenElement ?
        document.exitFullscreen() :
        Promise.resolve(); // ì´ë¯¸ ì „ì²´í™”ë©´ì´ ì•„ë‹ˆê±°ë‚˜ API ë¯¸ì§€ì› ì‹œ

    exitFullscreenPromise.catch(err => {
        console.warn("ì „ì²´í™”ë©´ ì¢…ë£Œ ì‹¤íŒ¨:", err);
    }).finally(() => {
        restoreInitialUI();
    });
}

function restoreInitialUI() {
    htmlEl.classList.remove('fullscreen-active-mode');
    showInitialUIElements(true); // ìˆ¨ê²¼ë˜ UI ìš”ì†Œë“¤ ë‹¤ì‹œ ë³´ì´ê¸°
    touchInstructionMessage.classList.add("hidden"); // í„°ì¹˜ ì•ˆë‚´ ë©”ì‹œì§€ë„ í™•ì‹¤íˆ ìˆ¨ê¸°ê¸°

    // ë°°ê²½ìƒ‰ì„ ì´ˆê¸° ìƒíƒœ(í°ìƒ‰)ë¡œ ë³µì›
    document.body.style.backgroundColor = "white";
    document.documentElement.style.backgroundColor = "white";
    document.body.style.cursor = "default"; // ì»¤ì„œ ë³´ì´ê¸°
}

function showNextColor() {
    if (!testStarted) return;

    currentIndex++;
    if (currentIndex >= colors.length) {
        endTest();
    } else {
        const currentColor = colors[currentIndex];
        document.body.style.setProperty("background-color", currentColor, "important");
        document.documentElement.style.setProperty("background-color", currentColor, "important");
    }
}

function playAndNavigate(soundId, nextPage) {
    const audio = document.getElementById(soundId);
    if (!audio) {
        location.href = nextPage;
        return;
    }
    audio.currentTime = 0;
    audio.play().then(() => {
        setTimeout(() => {
            location.href = nextPage;
        }, 400);
    }).catch(() => { // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ì´ë™
        location.href = nextPage;
    });
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
startButton.addEventListener("click", prepareForTest);
startButton.addEventListener("touchstart", (e) => {
    e.preventDefault(); // ë”ë¸”íƒ­ í™•ëŒ€ ë“± ë°©ì§€
    prepareForTest();
}, { passive: false });

// í™”ë©´ ì „ì²´ì— ëŒ€í•œ í„°ì¹˜/í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleBodyInteraction(event) {
    // ìŠ¤íƒ€íŠ¸ ë²„íŠ¼ì´ë‚˜ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì´ í•¸ë“¤ëŸ¬ê°€ ë°˜ì‘í•˜ì§€ ì•Šë„ë¡
    if (event.target === startButton || navButtons.contains(event.target)) {
        return;
    }

    if (!testStarted && !touchInstructionMessage.classList.contains("hidden")) {
        // "í™”ë©´ í„°ì¹˜" ë©”ì‹œì§€ê°€ ë³´ì´ê³ , ì•„ì§ í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ì¼ ë•Œ -> í…ŒìŠ¤íŠ¸ ì‹œì‘
        initiateColorChangeAndFullscreen();
    } else if (testStarted) {
        // í…ŒìŠ¤íŠ¸ê°€ ì´ë¯¸ ì§„í–‰ ì¤‘ì¼ ë•Œ -> ë‹¤ìŒ ìƒ‰ìƒ
        showNextColor();
    }
}

document.body.addEventListener("click", handleBodyInteraction);
document.body.addEventListener("touchstart", (e) => {
    // ìŠ¤íƒ€íŠ¸ ë²„íŠ¼ì´ë‚˜ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í„°ì¹˜ ì‹œì—ëŠ” ì´ í•¸ë“¤ëŸ¬ê°€ ë°˜ì‘í•˜ì§€ ì•Šë„ë¡
    if (e.target === startButton || navButtons.contains(e.target)) {
        return;
    }
    e.preventDefault(); // ìŠ¤í¬ë¡¤, í™•ëŒ€/ì¶•ì†Œ ë“± ê¸°ë³¸ ë™ì‘ ë°©ì§€
    handleBodyInteraction(e); // ì´ë²¤íŠ¸ ê°ì²´ ì „ë‹¬ì€ í•„ìˆ˜ëŠ” ì•„ë‹˜
}, { passive: false });

document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        if (testStarted) {
            endTest();
        }
    }
});

// ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ê°ì§€
document.addEventListener('fullscreenchange', () => {
    // ì‚¬ìš©ìê°€ ESC í‚¤ ë“±ìœ¼ë¡œ ì§ì ‘ ì „ì²´í™”ë©´ì„ í•´ì œí–ˆì„ ë•Œ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
    if (!document.fullscreenElement && testStarted) {
        endTest();
    }
});
</script>

</body>
</html>
